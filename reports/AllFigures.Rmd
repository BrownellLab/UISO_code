Main Tables and Figures
========================================================

```{r load, message=FALSE, warning=FALSE, echo=FALSE}
# Here's how to compile this file in R, assuming your current directory is the repository root:

# library(knitr)
# knit("./reports/AllFigures.Rmd", encoding="utf-8")

library(affy)
library(ggplot2)
library(reshape)
library(plyr)
library(cluster)
library(xtable)
library(MASS)
library(venneuler)
library(limma) # For vennDiagram

options(xtable.type="html")
```

```{r loadexpr, echo=FALSE}
load("../cache/eset.original.filter.RData")
dataset <- eset.original.filter
```


```{r dopca, message=FALSE, warning=FALSE, echo=FALSE}
pca <- prcomp(t(exprs(dataset)), scale=TRUE, center=TRUE)
pc <- pca$x

plotdata <- data.frame(pc, sample=rownames(pc))
rownames(plotdata) <- rownames(pc)
plotdata <- cbind(plotdata[rownames(pc), ], pData(dataset)[rownames(pc), ])

pca.summary <- summary(pca)
pca.var <- data.frame(variance=pca.summary$importance[2, ], pc=names(pca.summary$importance[2, ]))

```

Figure 1: UISO cell line samples are in a distinct group from MCC tumor samples and classic MCC cell lines.
--------------------

Principal components analysis of microarray expression data from MCC cell lines and MCC and SCLC frozen tumor samples computed from variance-filtered probeset expression values for each sample. The variance in the expression data accounted for by PCâ€™s one and two are 23% and 20%, respectively (PC3: 7%).

```{r pcascatter, message=FALSE, warning=FALSE, echo=FALSE, fig.width=10, fig.height=10}
## Plot on PC1 and PC2
pc.data <- data.frame(pc, sample=rownames(pc))
rownames(pc.data) <- rownames(pc)
pc.data <- cbind(pc.data[rownames(pc), ], pData(dataset)[rownames(pc), ])

p <- ggplot(pc.data, aes(x=PC1, y=PC2)) + geom_point(aes(color=cancertype, 
                                                         shape=factor(sample.type, 
                                                                      labels=c("Cell line", "Tissue"))),
                                                     size=6)
p <- p + xlim(-75, 200)
p <- p + geom_text(aes(label=rownames(pc.data)), hjust=0.8, vjust=-0.75, size=4)
p <- p + scale_colour_brewer("Cancer type", palette="Set1")
p <- p + scale_shape_manual("Sample type", values=c(18,16))

xlabel <- substitute(paste("Principal component 1 (", sigma^2, " = ", s2, ")"),
                     list(s2=round(pca.var[1, "variance"], 2)))
ylabel <- substitute(paste("Principal component 2 (", sigma^2, " = ", s2, ")"),
                     list(s2=round(pca.var[2, "variance"], 2)))

p <- p + labs(x=xlabel, y=ylabel)
p <- p + theme_bw() + theme(legend.position=c(0.85, 0.85),
                           legend.title=element_text(size=14),
                           legend.text=element_text(size=12),
                           legend.background=element_rect(colour="black"),
                           axis.title.x=element_text(size=14), axis.title.y=element_text(size=14, angle=90),
                           axis.text.x=element_text(size=12), axis.text.y=element_text(size=12),
                           panel.background=element_rect())

print(p)

ggsave("../graphs/pc1v2.pdf", p, width=10, height=10)

```


Figure 2: UISO cell lines cluster separately from other MCC samples and cell lines.
------------------------

Hierarchical clustering of microarray expression data from MCC cell lines and MCC and SCLC frozen tumor samples. Average linkage was applied for merging clusters to the variance-filtered probeset expression values. One minus the Spearman correlation was used as a dissimilarity metric.

```{r hierclust, message=FALSE, warning=FALSE, echo=FALSE, fig.width=12, fig.height=6}
dataset <- eset.original.filter
d <- as.dist(1 - cor(exprs(dataset), method="spearman"))
plot(agnes(d, diss=TRUE, method='average'), which.plots=2, xlab="Dissimilarity = 1 - Correlation", main="Average Linkage")

pdf("../graphs/hier.pdf", width=12, height=6)
plot(agnes(d, diss=TRUE, method='average'), which.plots=2, xlab="Dissimilarity = 1 - Correlation", main="Average Linkage")
foo <- dev.off() # so device number is not printed.

```

Figure 3: UISO cell line samples have significantly more differentially expressed genes when compared to MCC tumor samples.
-----------------------
```{r venn1, message=FALSE, warning=FALSE, echo=FALSE, fig.width=10, fig.height=10}
load("../cache/testdec.RData")
load("../cache/testdec.list.RData")
load("../cache/testdec.df.RData")

# At time of writing, Vennerable could not be installed for R 3.0.0
# If you have R <= 2.15, install Vennerable and then the following will run

# testdec.venn <- Venn(testdec.list)
# pdf("graphs/proportionalvenn.cellvstumor.pdf", width=10, height=10)
# plot(testdec.venn, doWeights=TRUE, show=list(Faces=TRUE), type="circles")
# dev.off()

# This is a workaround using venneuler
# The plot is representative of the one in the publication
setmember <- with(ldply(testdec.list, .fun=length), rep(.id, V1))
element <- as.character(unlist(testdec.list))
m <- data.frame(element, setmember)
v <- venneuler(m)
# pdf("graphs/proportionalvenn.cellvstumor.pdf", width=10, height=10)
plot(v)
# dev.off()
```
```{r venn2, message=FALSE, warning=FALSE, echo=FALSE, fig.width=10, fig.height=10}
# # Regular venn diagram to see the counts of things in each set
# pdf("graphs/venn.cellvstumor.pdf")
vennDiagram(testdec[, 1:3])
# dev.off()
```

Figure 4: UISO cell lines are in a distinct group from other MCC cell lines and neuroendocrine lines from the Cancer Cell Line Encyclopedia.
--------------------
```{r pcaccle, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
load("../cache/eset.batcheffect.nomod.RData")

dataset <- eset.batcheffect.nomod
pca <- prcomp(t(exprs(dataset)), scale=TRUE, center=TRUE)
pc <- pca$x

plotdata <- data.frame(pc, sample=rownames(pc))
rownames(plotdata) <- rownames(pc)
plotdata <- cbind(plotdata[rownames(pc), ], pData(dataset)[rownames(pc), ])

pca.summary <- summary(pca)
pca.var <- data.frame(variance=pca.summary$importance[2, ], pc=names(pca.summary$importance[2, ]))
```

```{r pcascatterccle, message=FALSE, warning=FALSE, echo=FALSE, fig.width=10, fig.height=10}
## Plot on PC1 and PC2

plotdata$plot.type <- plotdata$cancer.type

mcc.uisos <- grepl("UISO", rownames(plotdata))

plotdata$plot.type <- as.character(plotdata$plot.type)
plotdata$plot.type[mcc.uisos] <- "UISO"
plotdata$plot.type <- factor(plotdata$plot.type)

mcc.uisos <- grep("UISO", plotdata$labels, value=FALSE)

plotdata.other <- subset(plotdata, !(plot.type %in% c('MCC', 'UISO')))
plotdata.MCC <- subset(plotdata, plot.type == 'MCC')
plotdata.UISO <- subset(plotdata, plot.type == 'UISO')

legend.labels <- levels(plotdata$plot.type)
legend.labels <- legend.labels[-c(6,10)]

p <- ggplot()
p <- p + geom_point(data=plotdata.other, aes(x=PC1, y=PC2, color=plot.type), alpha=0.5, size=5, show_guide=TRUE)

p <- p + scale_colour_manual("Cancer type",
                            values=c("#E41A1C", "#377EB8", "#4DAF4A",
                                     "#984EA3", "#FF7F00", "#D94801",
                                     "#A65628", "#F781BF"),
                            labels=legend.labels) 

p <- p + geom_point(data=plotdata.MCC, aes(x=PC1, y=PC2), size=7, color="black")
p <- p + geom_point(data=plotdata.MCC, aes(x=PC1, y=PC2),
                    size=5, color="#F41A1C")
p <- p + geom_text(data=plotdata.MCC, aes(x=PC1, y=PC2, 
                                          label=rownames(plotdata.MCC)),
                   hjust=1.0, vjust=-1.25, size=4)

p <- p + geom_point(data=plotdata.UISO, aes(x=PC1, y=PC2), size=7, color="black")
p <- p + geom_point(data=plotdata.UISO, aes(x=PC1, y=PC2),
                    size=5, color="#6BAED6")
p <- p + geom_text(data=plotdata.UISO, aes(x=PC1, y=PC2,
                                           label=rownames(plotdata.UISO)),
                   hjust=-0.1, vjust=-0.75, size=4)


xlabel <- substitute(paste("Principal component 1 (", sigma^2, " = ", s2, ")"),
                     list(s2=round(pca.var[1, "variance"], 2)))
ylabel <- substitute(paste("Principal component 2 (", sigma^2, " = ", s2, ")"),
                     list(s2=round(pca.var[2, "variance"], 2)))

p <- p + labs(x=xlabel, y=ylabel)
p <- p + theme_bw() + theme(legend.position=c(0.85, 0.85),
                            legend.title=element_text(size=14),
                            legend.text=element_text(size=12),
                            legend.background=element_rect(colour="black"),
                            panel.background = element_rect(fill = "#FFFFFF"))
print(p)

ggsave("../graphs/pc1v2ccle.pdf", p, width=12, height=12)

```

Table 1: A random forest classifier trained on MCC tumor samples does not classify UISO cell lines as MCC.
--------------------------------------------------------------------------------
A random forest classifier was trained using the filtered microarray probeset expression data for 23 MCC and 8 SCLC tumor samples. The classifier was then applied to the MCC cell lines, and the average class prediction was determined for each (over sample replicates). The class assignment (MCC and SCLC) probability is given as the fraction of trees in the random forest voting for each class. The values shown are the mean of six replicates for WaGa and Mkl-1, three replicates of UISO, and a single sample for MC01.
```{r loadrf, echo=FALSE, error=FALSE, warning=FALSE, cache=FALSE, message=FALSE}
load("../cache/rf.eset.RData")
load("../cache/rf.predict.RData")
load("../cache/rf.eset.unsupervised.RData")
```

``` {r testerror, echo=FALSE, results='asis'}
rf.predict$class <- factor(rf.predict$class, levels=c("WaGa", "Mkl1", "MC01", "UISO"), 
                           labels=c("WaGa", "Mkl-1", "MC01", "UISO"))
rf.predict.mean <- ddply(rf.predict, "class", function(x) data.frame(MCC=mean(x$MCC), SCLC=mean(x$SCLC)))
rf.predict.mean.xtable <- xtable(rf.predict.mean)
print(rf.predict.mean.xtable)
```
